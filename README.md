# OrgFinance: Multi-Tenant Financial Tracker

A sophisticated multi-tenant web application designed to help individuals, student groups, and small businesses track their financial health with a "Business-First" mindset. Built with resilience in mind, OrgFinance implements a database keep-alive system to prevent Supabase free-tier auto-pausing.

## ğŸ¯ Project Vision

OrgFinance solves two critical challenges:

1. **Complex Financial Tracking**: Unlike standard expense trackers, it distinguishes between operational expenses (business funds) and capital injections (out-of-pocket member payments). It also supports advanced features like held allocations (baseline business funds allocated to members) and initial setup transactions.

2. **Serverless Infrastructure Resilience**: Implements a lightweight keep-alive system using Vercel Cron Jobs that ping the database daily to prevent automatic pausing, with full audit logging for monitoring.

---

## ğŸ—ï¸ Core Architecture: Database Keep-Alive System

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Vercel Cron Job (Daily at ~1:00 AM UTC)         â”‚
â”‚         (Hobby Plan: Â±1 hour timing variance)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  GET /api/health-check       â”‚
        â”‚  (Protected by CRON_SECRET)  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Query Database Activity     â”‚
        â”‚  - Count organizations       â”‚
        â”‚  - Count transactions        â”‚
        â”‚  - Measure response time     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Log to keep_alive_logs      â”‚
        â”‚  (Audit Trail & Monitoring)  â”‚
        â”‚  (Prevents Auto-Pause)       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Implementation Details:**
- **Trigger**: Vercel Cron Job configured in `vercel.json`
- **Schedule**: `0 1 * * *` (daily at ~1:00 AM UTC, Hobby plan has Â±1 hour variance)
- **Security**: Protected by `CRON_SECRET` environment variable
- **Monitoring**: All executions logged to `keep_alive_logs` table
- **Purpose**: Prevents Supabase free-tier from pausing after 7 days of inactivity

---

## âœ¨ Core Features

### 1. **Multi-Tenancy (Organizations)**
- **Create**: Users can spawn new organizations and automatically become Owner
- **Join**: Users join existing organizations using a unique 12-character alphanumeric Invite Code (never expires, optional usage limits)
- **Context Switching**: Toggle between different organizations without logging out
- **Role-Based Access**: Owner, Admin, and Member roles with granular permissions
- **Member Management**: Soft delete/reactivate members, change roles, manage invite codes
- **Ownership Transfer**: Secure API endpoint for transferring ownership between members

### 2. **Advanced Financial Logic**
- **Income**: Revenue generated by the organization
- **Expense (Business Funds)**: Money spent from organization's cash-on-hand
- **Expense (Personal/Out-of-Pocket)**: Capital injections or expenses paid using personal funds (tracked as member equity contributions)
- **Refund**: Reimbursements paid to members for out-of-pocket expenses
- **Initial Transactions**: Owner-only setup transactions for recording pre-existing balances (marked with `is_initial` flag)
- **Held Allocations**: Baseline allocation of business funds to specific members (`held_allocation_add`/`held_allocation_remove`)
- **User Balance Tracking**: Each member can view their personal contribution balance, held amounts, and transaction history
- **Reimbursement System**: Track out-of-pocket expenses that need reimbursement
- **Reporting**: Automatic calculation of Cash on Hand, Total Income, Business Expenses, Personal Contributions, Actual Expenses, Net Profit, and per-user contribution balances
- **Bulk Operations**: Owners can add income/expenses on behalf of other members

### 3. **Database Keep-Alive System**
- **Automatic Daily Ping**: Vercel Cron Job runs daily at ~1:00 AM UTC (Hobby plan: Â±1 hour variance)
- **Health Check Endpoint**: `/api/health-check` queries database statistics (organization count, transaction count, response time)
- **Audit Logging**: All executions logged to `keep_alive_logs` table with status, timing, and error details
- **Security**: Protected by `CRON_SECRET` environment variable to prevent unauthorized access
- **Purpose**: Prevents Supabase free-tier from auto-pausing after 7 days of inactivity
- **Future Enhancement**: Google Sheets backup integration planned for Phase 6+

### 4. **Modern UI/UX**
- Built with Shadcn UI (Radix primitives + Tailwind CSS)
- Collapsible sidebar navigation with organization switcher
- Light/dark theme toggle with persistent preferences
- Intuitive dashboard with key financial metrics and member balances
- Mobile-responsive design
- Sheet-based modals for transaction entry and management

---

## ï¿½ï¸ Database Schema Design

### **Core Design Principles**
1. **Simple Money Source Tracking**: Two categories only - "business" (organization funds) vs "personal" (out-of-pocket/capital)
2. **User Accountability**: Every transaction tracks who created it AND who funded it
3. **On-Demand Balance Calculation**: User contribution balances calculated when needed (optimized for small datasets)
4. **Optional Reimbursement System**: Track personal expenses needing reimbursement (approval disabled by default, can be enabled per organization)
5. **Cost-Splitting Support**: Optional allocation table for shared expenses

### **Key Tables**

#### `transactions` (Enhanced)
Core financial records with accountability fields:
- `id`, `organization_id`, `user_id` (who recorded it)
- `type`: income | expense_business | expense_personal | refund | held_allocation_add | held_allocation_remove
- `amount`, `description`, `category`, `occurred_at`
- **`funded_by_type`**: "business" | "personal"
- **`funded_by_user_id`**: Who actually paid (null = business account)
- **`updated_by_user_id`**: Audit trail for edits
- **`is_initial`**: Boolean flag for owner-created setup transactions
- `created_at`, `updated_at`

#### `user_contributions`
Per-user balance tracking (calculated on-demand):
- `organization_id`, `user_id`
- `total_contributed`: Sum of personal funds added
- `total_received`: Sum of reimbursements received
- `net_balance`: Calculated field (contributed - received)
- `last_calculated_at`: Cache timestamp

#### `reimbursement_requests`
Track out-of-pocket expenses needing reimbursement:
- `id`, `organization_id`, `transaction_id`
- `from_user_id` (who paid out-of-pocket)
- `to_user_id` (who will reimburse, often null = "organization")
- `amount`, `status` (pending | approved | paid | rejected)
- `approval_required`: Boolean (per-org setting)
- `created_at`, `resolved_at`

#### `transaction_allocations` (Optional)
Support for split/shared costs:
- `transaction_id`, `user_id`
- `allocated_amount`: This user's share
- `allocation_reason`: Optional note

#### `keep_alive_logs`
Audit trail for database keep-alive system:
- `id`, `executed_at`, `database_active`
- `organization_count`, `transaction_count`, `response_time_ms`
- `status`: success | error | warning
- `error_message`: Error details if applicable
- `created_at`

### **User-Facing Views**
Each user sees:
1. **Personal Balance**: Total contributed, total received, net balance
2. **Transaction History**: All transactions they created or funded
3. **Reimbursements**: Out-of-pocket expenses awaiting reimbursement
4. **Organization Overview**: All organization transactions (role-based access)

---

## ï¿½ğŸ› ï¸ Tech Stack

| Layer | Technology |
|-------|-----------|
| **Frontend** | Next.js 16 (App Router), React 19, TypeScript, Tailwind CSS 4 |
| **UI Components** | Shadcn UI (Radix primitives), Lucide React (icons) |
| **Backend** | Supabase (PostgreSQL, Auth, Row Level Security) |
| **Automation** | Vercel Cron Jobs (keep-alive system) |
| **Authentication** | Supabase Auth (Google OAuth + Email/Password) |
| **Deployment** | Vercel (Edge Runtime for API routes) |
| **Future Integrations** | Google Sheets API (planned for backup system) |

---

## ğŸš€ Implementation Roadmap

### **Phase 1: Foundation & Core Infrastructure** âœ… **COMPLETE**
- [âœ…] Set up Next.js project with TypeScript and Tailwind CSS
- [âœ…] Configure Supabase project (PostgreSQL database, Auth)
- [âœ…] Implement database schema:
  - `profiles` table with OAuth integration
  - `organizations` table with description field
  - `organization_members` table (junction with roles, soft delete)
  - `transactions` table with enhanced accountability fields:
    - `funded_by_type`: Distinguish "business" vs "personal" funds
    - `funded_by_user_id`: Track who actually paid (if different from creator)
    - `updated_by_user_id`: Audit trail for edits
    - `is_initial`: Flag for owner-created setup transactions
    - Support for held allocation transaction types
  - `user_contributions` table: Track per-user balances (calculated on-demand)
  - `reimbursement_requests` table: Track out-of-pocket expenses needing reimbursement
  - `transaction_allocations` table: Support cost-splitting for shared expenses
  - `invite_codes` table for organization invitations (12-char alphanumeric, never expires)
  - `keep_alive_logs` table: Audit trail for database keep-alive pings
  - Row Level Security (RLS) policies for multi-tenancy
- [âœ…] Set up environment variables and secrets management
- [âœ…] Create basic project structure and folder organization

### **Phase 2: Authentication & User Management** âœ… **COMPLETE**
- [âœ…] Implement Google OAuth sign-up/login
- [âœ…] Implement Email/Password authentication
- [âœ…] Create user profile management (auto-created via trigger)
- [âœ…] Implement session persistence
- [âœ…] Add logout functionality
- [âœ…] Set up Supabase RLS policies for user data isolation
- [âœ…] OAuth callback handling

### **Phase 3: Organization Management** âœ… **COMPLETE**
- [âœ…] Create "Create Organization" form
- [âœ…] Implement organization switching in UI (sidebar navigation)
- [âœ…] Generate unique 12-character alphanumeric invite codes (never-expiring, optional usage limits)
- [âœ…] Build "Join Organization" feature
- [âœ…] Create organization settings page (name, description, initial values, regular expenses/income)
- [âœ…] Implement role-based access control (Owner, Admin, Member)
- [âœ…] Add member management UI:
  - View all members (active/inactive tabs)
  - Change roles (Admin/Member)
  - Deactivate/reactivate members (soft delete)
  - Manage invite codes (create, revoke, view usage)
- [âœ…] Transfer ownership API endpoint
- [âœ…] Holdings management page for held allocations

### **Phase 4: Transaction Management - Core Data Layer** âœ… **COMPLETE**
- [âœ…] Implement transaction input forms:
  - Transaction type selector (Income, Expense-Business, Expense-Personal, Refund)
  - **Funded by**: Business account or specific user (for personal funds)
  - Amount input with validation
  - Description/notes
  - Date picker
  - Category selector
- [âœ…] Add transaction list view with type badges and formatting
- [âœ…] Implement transaction edit/delete functionality (with audit trail)
- [âœ…] Initial transactions system (owner-only, marked with `is_initial` flag)
- [âœ…] Held allocation system (add/remove held business funds to members)
- [âœ…] Bulk operations (owners can add income/expenses on behalf of members)

### **Phase 4.5: User Balance & Accountability** âœ… **COMPLETE**
- [âœ…] Create user contribution calculation service:
  - Calculate total contributed per user
  - Calculate reimbursements received
  - Calculate held allocations
  - Compute net balance on-demand
- [âœ…] Implement member balances display on dashboard
- [âœ…] Add refund/reimbursement system:
  - Create refund transactions for out-of-pocket expenses
  - Track refund status
- [âœ…] Cost-splitting support via `transaction_allocations` table

### **Phase 5: Dashboard & Analytics** âœ… **COMPLETE**
- [âœ…] Create dashboard layout with key metrics:
  - Cash on Hand (total available funds)
  - Total Income
  - Business Expenses
  - Personal Contributions
  - Actual Expenses (excluding capital)
  - Net Profit
  - **Per-User Balances**: Show each member's contribution and net balance
- [âœ…] Build transaction history table (recent 10 transactions with type badges)
- [âœ…] Implement financial calculations (via `lib/finance.ts`)
- [âœ…] Stats cards component for dashboard metrics

### **Phase 6: Keep-Alive & Backup System** âœ… **KEEP-ALIVE COMPLETE** | â³ **BACKUP PLANNED**
- [âœ…] **Keep-Alive System (Implemented):**
  - [âœ…] Create health-check API route (`/api/health-check`)
  - [âœ…] Add security with `CRON_SECRET` environment variable
  - [âœ…] Configure Vercel Cron Job (`vercel.json` - daily at ~1:00 AM UTC)
  - [âœ…] Create `keep_alive_logs` table for audit trail
  - [âœ…] Log execution stats (org count, transaction count, response time, status)
- [ ] **Google Sheets Backup (Future Enhancement):**
  - [ ] Set up Google Cloud Service Account
  - [ ] Implement Google Sheets API integration:
    - Create/retrieve Master Google Sheet per organization
    - Clear & Replace strategy implementation
    - Error handling and retry logic
  - [ ] Add backup trigger to health-check cron
  - [ ] Test with multiple organizations simultaneously

### **Phase 7: Backup & Data Recovery** (Week 7)
- [ ] Create user-facing backup management page
- [ ] Implement backup history view
- [ ] Add manual backup trigger option
- [ ] Create data recovery from backup feature
- [ ] Add data export options (PDF, CSV)
- [ ] Implement backup versioning

### **Phase 8: Real-time Synchronization** (Week 8)
- [ ] Enable Supabase Realtime subscriptions
- [ ] Implement live transaction updates across tabs
- [ ] Add optimistic UI updates
- [ ] Create collaboration indicators (who's viewing what)
- [ ] Handle concurrent update conflicts

### **Phase 9: Testing & Quality Assurance** (Week 8-9)
- [ ] Unit tests for financial calculations
- [ ] Integration tests for API endpoints
- [ ] E2E tests for critical user flows
- [ ] Security testing (RLS policies, auth)
- [ ] Performance testing (large transaction datasets)
- [ ] Load testing for Edge Function

### **Phase 10: Deployment & DevOps** (Week 9)
- [ ] Configure CI/CD pipeline (GitHub Actions)
- [ ] Set up staging environment
- [ ] Deploy to production (Vercel)
- [ ] Configure custom domain
- [ ] Set up error tracking (Sentry)
- [ ] Create runbook for operations

### **Phase 11: Documentation & Launch** (Week 10)
- [ ] Create user documentation
- [ ] Write API documentation
- [ ] Create deployment guide
- [ ] Record video tutorials
- [ ] Set up support channels
- [ ] Plan launch strategy

### **Phase 12: Advanced Features** (Post-Launch)
- [ ] [ ] Advanced reporting (tax summaries, balance sheets)
- [ ] [ ] Budget planning and forecasting
- [ ] [ ] Receipt/document attachment storage
- [ ] [ ] Multi-currency support
- [ ] [ ] Integration with accounting software (QuickBooks, etc.)
- [ ] [ ] Audit logs and compliance reporting
- [ ] [ ] Mobile app (React Native)
- [ ] [ ] AI-powered expense categorization
- [ ] [ ] Webhook system for external integrations
- [ ] [ ] Enhanced Google Sheets templates (pivot tables, charts)

---

## ğŸ“‹ Development Workflow

### Branching Strategy
- `main` - Production releases
- `develop` - Integration branch (no direct commits; create a branch, PR/merge into `develop`)
- `init/*` - One-time initialization branches (e.g., foundation setup) merged into `develop`
- `feature/*` - One feature or page per branch; merge back to `develop`
- `bugfix/*` - Bug fix branches; merge back to `develop`

**Note:** Create a dedicated branch for each page/feature before starting work, then merge into `develop` via PR.

### Database Migrations
All schema changes use Supabase migrations to maintain version control.

For Phase 1 the source of truth lives in `supabase/schema.sql` (run in the Supabase SQL editor). See `docs/database.md` for table/policy details.

### Security Considerations
- All data access filtered through RLS policies
- OAuth tokens securely stored in Supabase Auth
- Edge Function secrets managed via Supabase environment variables
- Google Service Account key stored securely
- **Audit trails**: All transaction edits tracked via `updated_by_user_id`
- **Balance integrity**: On-demand calculation prevents cache desynchronization

### Roles & Permissions (Supabase)
- **Owner**: Full control; can transfer ownership and delete organization (exclusive)
- **Admin**: Can manage roles/invites, accept invites, and create/update/delete transactions, manage reimbursements
- **Member (Viewer)**: Read-only for org data and transactions, can view personal balance and contribution history

Auth: Email or Google OAuth. Redirects: `${NEXT_PUBLIC_SUPABASE_URL}/auth/v1/callback` (prod) and `http://localhost:3000/auth/callback` (dev).

### Local Setup
1) Copy `.env.example` to `.env.local` and fill in required variables:
   - `NEXT_PUBLIC_SUPABASE_URL` and `NEXT_PUBLIC_SUPABASE_ANON_KEY` (from Supabase Dashboard)
   - `SUPABASE_URL` and `SUPABASE_ANON_KEY` (same as above)
   - `CRON_SECRET` (generate a strong random string for health-check endpoint security)
   - Optional: `SUPABASE_SERVICE_ROLE_KEY` (for admin scripts and health-check logging)
   - Optional: Google OAuth credentials if using Google sign-in
2) Install deps: `npm install`
3) Apply database migrations:
   - Run each migration file in `supabase/migrations/` in order (001 through 008)
   - Use Supabase SQL Editor or CLI
4) Run dev server: `npm run dev`
5) Deploy to Vercel: Cron job will automatically run based on `vercel.json` configuration

### Creating Test Users

To test the authentication flow, you need to create test user accounts:

**Option 1: Using the Sign-Up Form** (Recommended for basic testing)
1. Go to `http://localhost:3000/auth`
2. Click "Need an account? Sign up" to toggle to sign-up mode
3. Enter email (e.g., `test@example.com`) and password (e.g., `TestPassword123!`)
4. Click "Create Account"
5. Use the same credentials to log in

**Option 2: Using the Admin Script** (For direct database user creation)
1. Get your Supabase Service Role Key from the Supabase Dashboard (Settings â†’ API â†’ Service Role)
2. Add to `.env.local`: `SUPABASE_SERVICE_ROLE_KEY=<your-key>`
3. Run: `node scripts/create-test-user.mjs`
4. Use the printed credentials to log in

**Testing OAuth (Google Sign-In)**
1. Click "Continue with Google" on the login page
2. A new profile will be automatically created via Supabase trigger
3. You'll be redirected to the organizations page after OAuth completes

---

## ğŸ” Security & Compliance

- **Row-Level Security (RLS)**: Users can only access organizations they belong to
- **Data Encryption**: All connections use HTTPS/TLS
- **Audit Logging**: Track all financial transactions with timestamps and user attribution (who created, who funded, who edited)
- **Balance Integrity**: On-demand calculation ensures accuracy without caching risks
- **Keep-Alive Security**: Health-check endpoint protected by `CRON_SECRET` environment variable
- **Soft Delete**: Members can be deactivated without losing historical data
- **OAuth Security**: Tokens securely stored in Supabase Auth
- **GDPR Compliance**: Data export and member deactivation capabilities

---

## ğŸ“Š Key Metrics to Track

- **Database Activity**: Transaction count, storage usage, keep-alive ping success rate
- **Keep-Alive Performance**: Execution time, response time, success rate (logged in `keep_alive_logs`)
- **User Adoption**: Sign-ups, organizations created, active members
- **Financial Integrity**: Calculation accuracy, audit log completeness, balance tracking
- **User Balance Accuracy**: Compare calculated vs expected balances for data integrity
- **Invite Code Usage**: Tracking invite code usage and conversion rates
- **Member Activity**: Active vs deactivated members, role distribution

---

## ğŸ¤ Contributing

This project is developed as part of a semester project. Contributions welcome via pull requests.

---

## ğŸ“„ License

[Add your license here]

---

## ğŸ“ Project Context

**Creator**: Kamish76  
**Repository**: Financial-tracker-ProjectDec1025  
**Status**: In Active Development  
**Current Phase**: Phase 5 Complete (Core Features Operational) | Phase 6 Keep-Alive Implemented  
**Last Updated**: January 2026

### Implementation Status Summary
- âœ… **Phases 1-5**: Fully implemented and operational
- âœ… **Phase 6 (Keep-Alive)**: Vercel Cron Job system implemented with audit logging
- â³ **Phase 6 (Backup)**: Google Sheets integration planned for future
- â³ **Phases 7-12**: Not yet started (testing, CI/CD, advanced features)

### Database Migrations Applied
1. `001_add_organization_description.sql` - Organization descriptions
2. `002_add_user_accountability_system.sql` - Transaction accountability
3. `003_fix_rls_recursion.sql` - RLS policy fixes
4. `004_allow_org_search_for_join.sql` - Join organization permissions
5. `005_add_initial_transactions.sql` - Initial/setup transactions
6. `006_add_held_allocation_types.sql` - Held allocation system
7. `007_add_member_soft_delete_and_invite_enhancements.sql` - Soft delete, invite improvements
8. `008_add_keep_alive_logs.sql` - Keep-alive audit logging