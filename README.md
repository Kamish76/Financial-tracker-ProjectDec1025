# OrgFinance: Multi-Tenant Financial Tracker with Keep-Alive Architecture

A sophisticated multi-tenant web application designed to help individuals, student groups, and small businesses track their financial health with a "Business-First" mindset. Built with resilience in mind, OrgFinance implements a self-keeping-alive architecture to overcome Supabase's free-tier pausing policy.

## ğŸ¯ Project Vision

OrgFinance solves two critical challenges:

1. **Complex Financial Tracking**: Unlike standard expense trackers, it distinguishes between operational expenses (business funds) and capital injections (out-of-pocket member payments).

2. **Serverless Infrastructure Resilience**: Implements an innovative "Keep-Alive Loop" architecture where daily backups to Google Sheets prevent database pausing while providing portable financial records.

---

## ğŸ—ï¸ Core Architecture: "The Keep-Alive Loop"

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Scheduled Edge Function (8:00 AM UTC)          â”‚
â”‚        (Supabase - Deno TypeScript Runtime)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Fetch Transaction Data      â”‚
        â”‚  from PostgreSQL Database    â”‚
        â”‚  (Prevents Auto-Pause)       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Transform & Validate        â”‚
        â”‚  (Apply Business Logic)      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Clear & Replace Strategy    â”‚
        â”‚  Google Sheets API Sync      â”‚
        â”‚  (Portable Backup)           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ¨ Core Features

### 1. **Multi-Tenancy (Organizations)**
- **Create**: Users can spawn new organizations and automatically become Admin
- **Join**: Users join existing organizations using a unique 6-digit Invite Code
- **Context Switching**: Toggle between different organizations without logging out
- **Role-Based Access**: Admin, Member, and Viewer roles with granular permissions

### 2. **Advanced Financial Logic**
- **Income**: Revenue generated by the organization
- **Expense (Business Funds)**: Money spent from organization's cash-on-hand
- **Expense (Personal/Out-of-Pocket)**: Capital injections or expenses paid using personal funds (tracked as member equity contributions)
- **User Balance Tracking**: Each member can view their personal contribution balance and transaction history
- **Reimbursement System**: Track out-of-pocket expenses that need reimbursement (approval system disabled by default, can be enabled per organization)
- **Reporting**: Automatic calculation of Cash on Hand, Total Capital, Net Profit, and per-user contribution balances

### 3. **Keep-Alive Backup System**
- **Automatic Daily Sync**: Scheduled Edge Function runs every morning at 8:00 AM UTC
- **Clear & Replace Strategy**: Ensures data integrity by rewriting sheet from scratch
- **Portable Access**: Users can access financial data offline via Google Sheets
- **Zero Cost Backup**: Leverages free Google Sheets API for unlimited historical records

### 4. **Modern UI/UX**
- Built with Shadcn UI (Radix primitives + Tailwind CSS)
- Real-time data synchronization
- Intuitive dashboard with key financial metrics
- Mobile-responsive design

---

## ï¿½ï¸ Database Schema Design

### **Core Design Principles**
1. **Simple Money Source Tracking**: Two categories only - "business" (organization funds) vs "personal" (out-of-pocket/capital)
2. **User Accountability**: Every transaction tracks who created it AND who funded it
3. **On-Demand Balance Calculation**: User contribution balances calculated when needed (optimized for small datasets)
4. **Optional Reimbursement System**: Track personal expenses needing reimbursement (approval disabled by default, can be enabled per organization)
5. **Cost-Splitting Support**: Optional allocation table for shared expenses

### **Key Tables**

#### `transactions` (Enhanced)
Core financial records with accountability fields:
- `id`, `organization_id`, `user_id` (who recorded it)
- `type`: income | expense_business | expense_personal
- `amount`, `description`, `category`, `occurred_at`
- **`funded_by_type`**: "business" | "personal"
- **`funded_by_user_id`**: Who actually paid (null = business account)
- **`updated_by_user_id`**: Audit trail for edits
- `created_at`, `updated_at`

#### `user_contributions`
Per-user balance tracking (calculated on-demand):
- `organization_id`, `user_id`
- `total_contributed`: Sum of personal funds added
- `total_received`: Sum of reimbursements received
- `net_balance`: Calculated field (contributed - received)
- `last_calculated_at`: Cache timestamp

#### `reimbursement_requests`
Track out-of-pocket expenses needing reimbursement:
- `id`, `organization_id`, `transaction_id`
- `from_user_id` (who paid out-of-pocket)
- `to_user_id` (who will reimburse, often null = "organization")
- `amount`, `status` (pending | approved | paid | rejected)
- `approval_required`: Boolean (per-org setting)
- `created_at`, `resolved_at`

#### `transaction_allocations` (Optional)
Support for split/shared costs:
- `transaction_id`, `user_id`
- `allocated_amount`: This user's share
- `allocation_reason`: Optional note

### **User-Facing Views**
Each user sees:
1. **Personal Balance**: Total contributed, total received, net balance
2. **Transaction History**: All transactions they created or funded
3. **Reimbursements**: Out-of-pocket expenses awaiting reimbursement
4. **Organization Overview**: All organization transactions (role-based access)

---

## ï¿½ğŸ› ï¸ Tech Stack

| Layer | Technology |
|-------|-----------|
| **Frontend** | Next.js (App Router), TypeScript, Tailwind CSS, Shadcn UI |
| **Backend** | Supabase (PostgreSQL, Auth, Realtime, Row Level Security) |
| **Automation** | Supabase Edge Functions (Deno/TypeScript) |
| **Authentication** | Supabase Auth (Google OAuth) |
| **External Integration** | Google Sheets API (Service Account) |
| **Validation** | Zod, React Hook Form |

---

## ğŸš€ Implementation Roadmap

### **Phase 1: Foundation & Core Infrastructure** (Weeks 1-2)
- [ ] Set up Next.js project with TypeScript and Tailwind CSS
- [ ] Configure Supabase project (PostgreSQL database, Auth)
- [ ] Implement database schema:
  - `users` table with OAuth integration
  - `organizations` table with admin/member relationships
  - `organization_members` table (junction with roles)
  - `transactions` table with enhanced accountability fields:
    - `funded_by_type`: Distinguish "business" vs "personal" funds
    - `funded_by_user_id`: Track who actually paid (if different from creator)
    - `updated_by_user_id`: Audit trail for edits
  - `user_contributions` table: Track per-user balances (calculated on-demand)
  - `reimbursement_requests` table: Track out-of-pocket expenses needing reimbursement
  - `transaction_allocations` table (optional): Support cost-splitting for shared expenses
  - `invite_codes` table for organization invitations
  - Row Level Security (RLS) policies for multi-tenancy
- [ ] Set up environment variables and secrets management
- [ ] Create basic project structure and folder organization

### **Phase 2: Authentication & User Management** (Weeks 2-3)
- [ ] Implement Google OAuth sign-up/login
- [ ] Create user profile management
- [ ] Implement session persistence
- [ ] Add logout functionality
- [ ] Set up Supabase RLS policies for user data isolation
- [ ] Add password/email recovery options

### **Phase 3: Organization Management** (Weeks 3-4)
- [ ] Create "Create Organization" form
- [ ] Implement organization switching in UI
- [ ] Generate unique 6-digit invite codes
- [ ] Build "Join Organization" feature
- [ ] Create organization settings page
- [ ] Implement role-based access control (Admin, Member, Viewer)
- [ ] Add member management UI (view, remove, change roles)

### **Phase 4: Transaction Management - Core Data Layer** (Weeks 4-5)
- [ ] Implement transaction input form with:
  - Transaction type selector (Income, Expense-Business, Expense-Personal)
  - **Funded by**: Business account or specific user (for personal funds)
  - Amount input
  - Description/notes
  - Date picker
  - Category selector
- [ ] Add transaction list view with filtering/sorting (by type, user, funding source)
- [ ] Implement transaction edit/delete functionality (with audit trail)
- [ ] Add bulk import from CSV (optional for Phase 1)
- [ ] Validate all financial operations with Zod schemas

### **Phase 4.5: User Balance & Accountability** (Week 5)
- [ ] Create user contribution calculation service:
  - Calculate total contributed per user
  - Calculate reimbursements received
  - Compute net balance on-demand
- [ ] Implement "My Contributions" page for each user:
  - Show personal balance summary
  - List transactions they created/funded
  - Display reimbursement requests
- [ ] Add reimbursement request system:
  - Create reimbursement request from out-of-pocket transaction
  - Track status (pending â†’ paid)
  - Manual approval flow (approval disabled by default)
- [ ] Optional: Implement cost-splitting UI for shared expenses

### **Phase 5: Dashboard & Analytics** (Weeks 5-6)
- [ ] Create dashboard layout with key metrics:
  - Cash on Hand (total available funds)
  - Total Capital (member equity contributions)
  - Net Profit (Income - Business Expenses)
  - **Per-User Balances**: Show each member's contribution and net balance
  - Transaction count and trends
- [ ] Build transaction history table (filterable by user, funding source, type)
- [ ] Implement basic charts (monthly income/expense trends, user contribution breakdown)
- [ ] Add financial ratio calculations
- [ ] Create printable/shareable reports
- [ ] Add organization settings:
  - Toggle reimbursement approval requirement
  - Configure notification preferences

### **Phase 6: Keep-Alive Architecture Setup** (Weeks 6-7)
- [ ] Create Supabase Edge Function (Deno/TypeScript):
  - Fetch all transactions from PostgreSQL
  - Calculate aggregate financial metrics
  - Format data for Google Sheets
- [ ] Set up Google Cloud Service Account
- [ ] Implement Google Sheets API integration:
  - Create/retrieve Master Google Sheet
  - Clear & Replace strategy implementation
  - Error handling and retry logic
- [ ] Configure Cron trigger (0 8 * * * UTC)
- [ ] Add logging and monitoring
- [ ] Test with multiple organizations simultaneously

### **Phase 7: Backup & Data Recovery** (Week 7)
- [ ] Create user-facing backup management page
- [ ] Implement backup history view
- [ ] Add manual backup trigger option
- [ ] Create data recovery from backup feature
- [ ] Add data export options (PDF, CSV)
- [ ] Implement backup versioning

### **Phase 8: Real-time Synchronization** (Week 8)
- [ ] Enable Supabase Realtime subscriptions
- [ ] Implement live transaction updates across tabs
- [ ] Add optimistic UI updates
- [ ] Create collaboration indicators (who's viewing what)
- [ ] Handle concurrent update conflicts

### **Phase 9: Testing & Quality Assurance** (Week 8-9)
- [ ] Unit tests for financial calculations
- [ ] Integration tests for API endpoints
- [ ] E2E tests for critical user flows
- [ ] Security testing (RLS policies, auth)
- [ ] Performance testing (large transaction datasets)
- [ ] Load testing for Edge Function

### **Phase 10: Deployment & DevOps** (Week 9)
- [ ] Configure CI/CD pipeline (GitHub Actions)
- [ ] Set up staging environment
- [ ] Deploy to production (Vercel)
- [ ] Configure custom domain
- [ ] Set up error tracking (Sentry)
- [ ] Create runbook for operations

### **Phase 11: Documentation & Launch** (Week 10)
- [ ] Create user documentation
- [ ] Write API documentation
- [ ] Create deployment guide
- [ ] Record video tutorials
- [ ] Set up support channels
- [ ] Plan launch strategy

### **Phase 12: Advanced Features** (Post-Launch)
- [ ] [ ] Advanced reporting (tax summaries, balance sheets)
- [ ] [ ] Budget planning and forecasting
- [ ] [ ] Receipt/document attachment storage
- [ ] [ ] Multi-currency support
- [ ] [ ] Integration with accounting software (QuickBooks, etc.)
- [ ] [ ] Audit logs and compliance reporting
- [ ] [ ] Mobile app (React Native)
- [ ] [ ] AI-powered expense categorization
- [ ] [ ] Webhook system for external integrations
- [ ] [ ] Enhanced Google Sheets templates (pivot tables, charts)

---

## ğŸ“‹ Development Workflow

### Branching Strategy
- `main` - Production releases
- `develop` - Integration branch (no direct commits; create a branch, PR/merge into `develop`)
- `init/*` - One-time initialization branches (e.g., foundation setup) merged into `develop`
- `feature/*` - One feature or page per branch; merge back to `develop`
- `bugfix/*` - Bug fix branches; merge back to `develop`

**Note:** Create a dedicated branch for each page/feature before starting work, then merge into `develop` via PR.

### Database Migrations
All schema changes use Supabase migrations to maintain version control.

For Phase 1 the source of truth lives in `supabase/schema.sql` (run in the Supabase SQL editor). See `docs/database.md` for table/policy details.

### Security Considerations
- All data access filtered through RLS policies
- OAuth tokens securely stored in Supabase Auth
- Edge Function secrets managed via Supabase environment variables
- Google Service Account key stored securely
- **Audit trails**: All transaction edits tracked via `updated_by_user_id`
- **Balance integrity**: On-demand calculation prevents cache desynchronization

### Roles & Permissions (Supabase)
- **Owner**: Full control; can transfer ownership and delete organization (exclusive)
- **Admin**: Can manage roles/invites, accept invites, and create/update/delete transactions, manage reimbursements
- **Member (Viewer)**: Read-only for org data and transactions, can view personal balance and contribution history

Auth: Email or Google OAuth. Redirects: `${NEXT_PUBLIC_SUPABASE_URL}/auth/v1/callback` (prod) and `http://localhost:3000/auth/callback` (dev).

### Local Setup
1) Copy `.env.example` to `.env.local` and fill Supabase + Google creds.
2) Install deps: `npm install`
3) Run dev server: `npm run dev`
4) Apply schema: paste `supabase/schema.sql` into Supabase SQL editor and run.

### Creating Test Users

To test the authentication flow, you need to create test user accounts:

**Option 1: Using the Sign-Up Form** (Recommended for basic testing)
1. Go to `http://localhost:3000/auth`
2. Click "Need an account? Sign up" to toggle to sign-up mode
3. Enter email (e.g., `test@example.com`) and password (e.g., `TestPassword123!`)
4. Click "Create Account"
5. Use the same credentials to log in

**Option 2: Using the Admin Script** (For direct database user creation)
1. Get your Supabase Service Role Key from the Supabase Dashboard (Settings â†’ API â†’ Service Role)
2. Add to `.env.local`: `SUPABASE_SERVICE_ROLE_KEY=<your-key>`
3. Run: `node scripts/create-test-user.mjs`
4. Use the printed credentials to log in

**Testing OAuth (Google Sign-In)**
1. Click "Continue with Google" on the login page
2. A new profile will be automatically created via Supabase trigger
3. You'll be redirected to the organizations page after OAuth completes

---

## ğŸ” Security & Compliance

- **Row-Level Security (RLS)**: Users can only access organizations they belong to
- **Data Encryption**: All connections use HTTPS/TLS
- **Audit Logging**: Track all financial transactions with timestamps and user attribution (who created, who funded, who edited)
- **Balance Integrity**: On-demand calculation ensures accuracy without caching risks
- **Rate Limiting**: Implement rate limits on API endpoints
- **GDPR Compliance**: Data export and deletion capabilities

---

## ğŸ“Š Key Metrics to Track

- **Database Activity**: Transaction count, storage usage
- **Edge Function Performance**: Execution time, success rate
- **Backup Success Rate**: Failed syncs, data discrepancies
- **User Adoption**: Sign-ups, organizations created, active users
- **Financial Integrity**: Calculation accuracy, audit log completeness, reimbursement tracking
- **User Balance Accuracy**: Compare calculated vs expected balances for data integrity

---

## ğŸ¤ Contributing

This project is developed as part of a semester project. Contributions welcome via pull requests.

---

## ğŸ“„ License

[Add your license here]

---

## ğŸ“ Project Context

**Creator**: Kamish76  
**Repository**: Financial-tracker-ProjectDec1025  
**Status**: In Active Development  
**Current Phase**: Foundation & Core Infrastructure